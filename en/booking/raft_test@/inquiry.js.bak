// メイン処理。
$(function(){

	// 都道府県の選択リストを設定する。
	/*
	if ($('input:visible').is('#pref')) {
		$('#pref').popupList({list:hanazono_form.prefList, cascade:false, colwidth:'5em'});
	}
	*/

	// 要素を格納する変数。
	var el = null;

	// 住所検索ボタンの説明とボタンを配置する。
	/*
	if ($('input:visible').is('#pref_code1')) {
		el = $('#tr_pref_code > td');
		el.prepend('<p class="ex"><em>※&nbsp;郵便番号を入力して住所検索ボタンを押すと、ご住所欄に自動入力されます。</em></p>');
		el.append('<button type="button" id="btn_search_address"><img src="../../common/img/btn_search_address.gif" width="75" height="25" alt="住所検索" /></button>');
		el.append('<div id="search_list"></div>');
		hanazono_form.displaySearchButton('../..');
	}
	*/

	// AjaxZip2の住所データのパスを設定する。
	//AjaxZip2.JSONDATA = '../../common/js/libs/ajaxzip2/data';

	// 郵便番号のテキストボックスにAjaxZip2を設定する。
	// 全角英数を半角に変換する。
	/*
	$('#pref_code2').keyup(function(){
		$(this).val($(this).val().hankaku());
		AjaxZip2.zip2addr('pref_code1','pref','city','pref_code2');
	}).blur(function(){ $(this).val($(this).val().hankaku()); })
	.after('<p class="ex"><em>※&nbsp;郵便番号を入力すると、自動的にご住所を設定します。</em></p>');
	*/
	
	// 戻るボタンを配置する。
	if ($('button').is('#btn_send')) {
		var btn_history_back = $('<button type="button" id="btn_history_back">' +
			'<img src="../../common/img/btn_history_back.gif" width="80" height="25" alt="Back(correct them)" />' +
			'</button>').clickpress(function(){ history.back(); });
		$('#btn_send').before(btn_history_back);
	}

	// ダイアログを設定。
	$('#msgbox').dialog({
		autoOpen  : false,
		modal     : true,
		draggable : false,
		resizable : false,
		show      : 'fade',
		hide      : 'fade',
		buttons : {
			'OK' : function(){
				$(this).dialog('close');
			}
		}
	});

	var today = new Date();
	var afterDate = new Date(today.getTime() + (2 * 86400000)); // 明後日
	var maxDate = new Date(today.getTime() + (366 * 86400000)); // 1年後
	var setTourDate = function(dt) {
		$('#tour_date_y').val(dt.getFullYear());
		$('#tour_date_m').val(dt.getMonth()+1);
		$('#tour_date_d').val(dt.getDate());
	};

	var tour_content = $('#tour_content');
	var hw1 = tour_content.find('option:eq(1)').val();
	var hw2 = tour_content.find('option:eq(2)').val();
	var hayawari = function(seldate){
		var choice = Date.create(seldate);
		var offer = Date.create().addDays(28); // 明後日の2日分を除く
		if (offer <= choice) {
			//tour_content.find('option:eq(1),option:eq(2)').show();
			if (!tour_content.is(':contains("' + hw1 + '")')) {
				tour_content.find('option:eq(0)').after('<option value="' + hw2 + '">' + hw2 + '</option>');
				tour_content.find('option:eq(0)').after('<option value="' + hw1 + '">' + hw1 + '</option>');
			}
		} else {
			if (tour_content.val() == hw1 || tour_content.val() == hw2) {
				tour_content.get(0).selectedIndex = 0;
			}
			//tour_content.find('option:eq(1),option:eq(2)').hide();
			if (tour_content.is(':contains("' + hw1 + '")')) {
				tour_content.find('option:eq(1),option:eq(2)').remove();
			}
		}
	};

	var isRaftBBQ = function(date){
		var d = Date.create(date);
		
		if (/^Online 10% discount Rafting Tour/.test(tour_content.val())) {
			
			// 4/29～5/6、その他5月中の土日、6/1～10/31以外は選択不可。
			if (d.isBetween('2012/4/28', '2012/5/7') || d.isBetween('2012/5/31', '2012/11/1')) {
				return true;
			} else if (d.getMonth() == 4 && (d.isSaturday() || d.isSunday())) {
				return true;
			} else {
				return false;
			}
		} else {
			return true;
		}
	};

	var raftTitle = 'ツアー予定日について';
	var raftMsg = [
		'該当の日付はご予約いただけません',
		'ラフティング＆BBQ温泉パックの実施は2011年4月29日～5月6日、5月の土日、6月1日～2011年10月下旬までとなります'
	].join("\n");

	tour_content.change(function(){
		if (!isRaftBBQ(selectDate)){
			$('#msgbox').dialog('open');
			//alert(raftMsg);
			$('#datepicker').datepicker('setDate', afterDate);
			setTourDate(afterDate);
		}
	});

	$('#datepicker').datepicker({
		'dateFormat': 'yy/mm/dd',
		'showMonthAfterYear': true,
		'minDate': 2, // 明後日から
		'maxDate': '+1y',
		'showOn': 'button',
		'buttonImageOnly': true,
		'buttonImage': './img/ico_calendar.png',
		/*
		'buttonText': '選択',
		'nextText': '来月',
		'prevText': '先月',
		'dayNames': ['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'],
		'dayNamesMin': ['日','月','火','水','木','金','土'],
		'dayNamesShort': ['日','月','火','水','木','金','土'],
		'monthNames': ['年 1 月','年 2 月','年 3 月','年 4 月','年 5 月','年 6 月','年 7 月','年 8 月','年 9 月','年 10 月','年 11 月','年 12 月'],
		*/
		'onSelect': function(dateText, inst) {
			var ymd = dateText.split('/');
			$('#tour_date_y').val(ymd[0]);
			$('#tour_date_m').val(ymd[1]/1);
			$('#tour_date_d').val(ymd[2]/1);
			hayawari(dateText);
		},
		'beforeShowDay' : function(date){
			
			if (isRaftBBQ(date)) {
				return [true, ''];
			} else {
				return [false, 'ui-state-disabled'];
			}
		}
	});

	$('#tour_date_y,#tour_date_m,#tour_date_d').change(function(e){
		var selectDate = new Date($('#tour_date_y').val(), $('#tour_date_m').val()-1, $('#tour_date_d').val());
		
		if (!isRaftBBQ(selectDate)){
			$('#msgbox').dialog('open');
			//alert(raftMsg);
			$('#datepicker').datepicker('setDate', afterDate);
			setTourDate(afterDate);
			return;
		}
		
		hayawari(selectDate);
		if (selectDate < afterDate) {
			$('#datepicker').datepicker('setDate', afterDate);
			setTourDate(afterDate);
		} else if (selectDate > maxDate) {
			$('#datepicker').datepicker('setDate', maxDate);
			setTourDate(maxDate);
		} else {
			$('#datepicker').datepicker('setDate', selectDate);
			setTourDate(selectDate);
		}
	});
	
	if ($('#mode').val() == 'form') {
		setTourDate(afterDate);
		setTimeout(function(){ $('#tour_date_y,#tour_date_m,#tour_date_d').change(); }, 1000);
	} else {
		var selectDate = new Date($('#tour_date_y').val(), $('#tour_date_m').val()-1, $('#tour_date_d').val());
		$('#datepicker').datepicker('setDate', selectDate);
	}

});
